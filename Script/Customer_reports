	
	Create View gold.report_customers As
	-- Preparation of Data Report and its Steps 
	--=========================================================
	-- Step1, Base Query: Retrive Core columns from Tables 
	
	-------------------------------------------------------
	
	With base_query As(
	Select 
	f.order_number,
	f.product_key,
	f.order_date,
	f.sales_amount,
	f.quantity,
	c.customer_key,
	-- join two column firstname and lastname 
	Concat(c.first_name,'    ',c.last_name) as Customer_name,
	DateDiff(year,c.birthdate,GETDATE()) as Age,
	c.customer_number
	from gold.fact_sales f
	left join gold.dim_customers c
	ON c.customer_key = f.customer_key
	-- Filtering of data 
	where order_date is not null)

	, Customer_Aggregation As(
	--------------------------------------------
	-- Customer_aggregation:Summarise key metrics at customer level
	----------------------------------------------------------
	Select 
	customer_key,
	Customer_name,
	Age,
	customer_number,
	Sum(sales_amount) as Total_sales,
	Count(distinct Order_number) as Total_Order,
	Sum(quantity) as Total_quantity,
	Count(distinct product_key) as Total_products,
	Max(order_date) as Last_Order,
	DateDiff(month,min(order_date),Max(order_date)) as LifeSpanMonths
	from base_query
	group by customer_key,Customer_name,Age,customer_number)

	Select 
	customer_key,
	Customer_name,
	customer_number,
	Total_sales,
	 Total_Order,
	 Total_quantity,
	Total_products,
	Last_Order,
	DateDiff(Month,Last_Order,GETDATE()) as Recency ,
	LifeSpanMonths,
	Age,
Case when LifeSpanMonths >= 12 and Total_sales > 5000 then 'VIP'
     when LifeSpanMonths >= 12 and Total_sales <= 5000 then 'Regular'
     Else 'New'
     End as Customer_segement,
Case when Age < 20 then 'UnderAge'
     when Age between 20 and 29 then '20-29'
	 when Age between 30 and 39 then '30-39'
	 when Age between 40 and 49 then '40-49'
	 Else '50 and Above'
	 End as Age_group,
-- Compute Average Order Value (KPI)
case when Total_Order = 0 then '0'
     else  Total_sales/Total_Order
	End as Avg_Value_Order,
-- compute Average monthly spent (KPI)
case when LifeSpanMonths = 0 then Total_sales
     Else Total_sales/LifeSpanMonths
	 End as monthlySpent 
    

From Customer_Aggregation
